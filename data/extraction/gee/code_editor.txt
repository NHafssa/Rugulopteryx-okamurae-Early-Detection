// DATASET: Sentinel-3 OLCI EFR: Ocean and Land Color Instrument Earth Observation Full Resolution
// ImageCollection ID: COPERNICUS/S3/OLCI
// DATASET URL: https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S3_OLCI

// CONSTANTS
var YEARS = [2016, 2017, 2018, 2019, 2020, 
             2021, 2022, 2023, 2024, 2025];

var REDUCER_YEAR = ee.Reducer.mean()
                             .combine(ee.Reducer.stdDev(), '', true);
var ROI = [ // lon min, lat min, lon max, lat max
  ee.Geometry.BBox(-30, 26, 15, 56),
  ee.Geometry.BBox(-115, 20, -101, 33),
  ee.Geometry.BBox(113, -45, 153, 41)
]

// HELPER FUNCTIONS
function processAndExportYear(year, num_years, bands, reducer, crs, resolution, 
                              suffix, dir_dst, img_col, bb, transforms) {
  /**
   * Processes and exports data for a single year.
   * @parameter year: Year.
   * @parameter num_years: No. of years to look ahead.
   * @parameter bands: Bands to export.
   * @parameter reducer: Type of reducer to apply per location for the year.
   * @parameter crs: Coordinate reference system of the image.
   * @parameter resolution: Image scale.
   * @parameter suffix: Suffix to add to end of saved filename.
   * @parameter dir_dst: Name of destination directory in drive.
   * @parameter img_col: Image collection ID.
   * @paramter bb: Region to consider such as
   *               ee.Geometry.BBox(-180, -90, 180, 90)
   *               for the entire surface.
   * @parameter transforms: List of preprocessing functions to 
   *                        apply to all images.
   */
  
  // Define date range.
  var dateStart = String(year) + "-01-01";
  var dateEnd = String(year + num_years) + "-01-01";
  
  // Get image collection for the year
  var imgCol = ee.ImageCollection(img_col)
                .filterDate(dateStart, dateEnd)
                .filterBounds(bb);
                
  // Apply transformation functions.
  for (var i = 0; i < transforms.length; i++) {
    imgCol = imgCol.map(transforms[i]);
  }
  
  // Select bands.
  imgCol = imgCol.select(bands);
  
  // Reduce the image collection
  var count = imgCol.size();
  var img = ee.Image(ee.Algorithms.If(
    count.gt(0), // Guard against empty collections.
    imgCol.reduce(reducer),
    ee.Image.constant(0).rename(bands) // Dummy image placeholder.
  ));
  
  // Create image export task.
  var filename = year + "_" + suffix;
  Export.image.toDrive({
    image: img,
    description: filename,
    region: bb,
    crs: crs,
    scale: resolution,
    maxPixels: 1e13,
    folder: dir_dst,
    fileNamePrefix: filename,
    skipEmptyTiles: true
  });
}

// PROCESS DATA FOR ALL REGIONS OF INTEREST ONE YEAR AT A TIME
for (var i = 0; i < ROI.length; i++) {
  var bounding_box = ROI[i];
  for (var j = 0; j < YEARS.length; j++) {
    var year = YEARS[j];
    processAndExportYear(
      year, // Starting year.
      1, // No. of years to consider.
      ['Oa08_radiance', 'Oa17_radiance', 'Oa21_radiance'], // Bands
      REDUCER_YEAR, // Reduction type.
      "EPSG:3857", // CRS
      5000, // Resolution
      "roi" + i, // Saved file suffix.
      "COPERNICUS-S3-OLCI", // Folder in Drive.
      'COPERNICUS/S3/OLCI', // ImageCollection ID
      bounding_box, // Region of interest.
      [] // Image transformation functions.
    ); 
  }
}